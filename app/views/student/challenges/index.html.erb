<div class="d-flex justify-content-center flex-column align-items-center no-margin-p">
  <div class="student-challenges-profile-container">
    <div class="student-challenges-profile-bar d-flex">
      <div class="student-challenges-profile-photo">
        <%= cl_image_tag current_user.photo.key, height: 100, width: 100, class: "student-challenge-profile-photo-cl" %>
      </div>
      <div class="student-challenges-profile-box ms-3 me-2 mt-2 d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Challenges</p>
        <p class="fw-bold text-white"><%= current_user.submissions.count %></p>
      </div>
      <div class="student-challenges-profile-box mx-2 mt-2 d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Games</p>
        <p class="fw-bold text-white"><%= current_user.submissions.flat_map(&:games).select { |game| game.score.present? }.count %></p>
      </div>
      <div class="student-challenges-profile-box-last mx-2 mt-2 me-auto d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Classroom</p>
        <p class="fw-bold text-white"><%= current_user.classrooms_as_student.first.name %></p>
      </div>
      <div class="student-challenges-profile-box mx-2 mt-2 d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Level</p>
        <p class="fw-bold text-white">22</p>
      </div>
      <div class="student-challenges-profile-box mx-2 mt-2 d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Total XP</p>
        <p class="fw-bold text-white"><%= @experience %></p>
      </div>
      <div class="student-challenges-profile-box-last mx-2 me-3 mt-2 d-flex flex-column align-items-center">
        <p class="m-2 student-challenges-profile-box-title">Learning</p>
        <%= image_tag "student_challenges_eng_flag.png", width: 30, height: 30  %>
      </div>
    </div>
  </div>
  <div class="student-challenges-challenges-container d-flex">
    <div class="d-flex student-challenges-card-container row flex-grow-1">
      <% @challenges.each do |challenge| %>
        <div class="student-challenges-card col-4 m-3 d-flex flex-column p-0">
          <% if challenge.photo.attached? %>
            <%= cl_image_tag challenge.photo.key, height: 200, width: "100%", class: "student-challenges-card-image" %>
          <% else %>
            <%= image_tag 'https://img.freepik.com/premium-vector/cute-black-ninja-read-book-illustration_295036-487.jpg', height: 200, width: "100%", class: "student-challenges-card-image" %>
          <% end %>
          <div class="d-flex justify-content-between align-items-end">
            <p class="text-white m-3 text-start student-challenges-card-title"><%= challenge.title %></p>
            <div class="mx-2 my-3 student-challenges-card-date">
              <%= challenge.due_date.strftime("%m月%d日") %>
            </div>
          </div>
          <% submission = challenge.submissions.find_by(user_id: current_user.id) %>
          <% if submission.nil? %>
            <%= link_to new_student_challenge_submission_path(challenge) do %>
              <div class="d-flex justify-content-between student-challenges-card-options mx-3 my-1">
                <p class="text-white py-2 px-3">Sentence Sensei</p>
              </div>
            <% end %>
          <% else %>
            <div class="d-flex justify-content-between align-items-center student-challenges-card-options mx-3 my-1">
              <p class="text-white py-2 px-3">Sentence Sensei</p>
              <%= image_tag "check.png", height: 20, width: 20, class: "mx-3" %>
            </div>
          <% end %>
          <% if submission.present? %>
            <%= link_to edit_student_submission_game_path(submission, submission.games.find_by(game_type: "grammar")) do %>
              <div class="d-flex justify-content-between align-items-center student-challenges-card-options mx-3 my-1">
                <p class="text-white py-2 px-3">Grammar Game</p>
                <% if submission.games.find_by(game_type: "grammar").score.present? %>
                  <%= image_tag "check.png", height: 20, width: 20, class: "mx-3" %>
                <% end %>
              </div>
            <% end %>
            <%= link_to edit_student_submission_game_path(submission, submission.games.find_by(game_type: "spelling")) do %>
              <div class="d-flex justify-content-between align-items-center student-challenges-card-options mx-3 my-1">
                <p class="text-white py-2 px-3">Spelling Game</p>
                <% if submission.games.find_by(game_type: "spelling").score.present? %>
                  <%= image_tag "check.png", height: 20, width: 20, class: "mx-3" %>
                <% end %>
              </div>
            <% end %>
            <%= link_to edit_student_submission_game_path(submission, submission.games.find_by(game_type: "vocab")) do %>
              <div class="d-flex justify-content-between align-items-center student-challenges-card-options mx-3 my-1">
                <p class="text-white py-2 px-3">Vocabulary Game</p>
                <% if submission.games.find_by(game_type: "vocab").score.present? %>
                  <%= image_tag "check.png", height: 20, width: 20, class: "mx-3" %>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="d-flex student-challenges-card-options mx-3 my-1">
              <p class="text-white py-2 px-3">Grammar Game</p>
            </div>
            <div class="d-flex student-challenges-card-options mx-3 my-1">
              <p class="text-white py-2 px-3">Spelling Game</p>
            </div>
            <div class="d-flex student-challenges-card-options mx-3 my-1">
              <p class="text-white py-2 px-3">Vocabulary Game</p>
            </div>
          <% end %>
          <div class="d-flex align-items-center justify-content-end mx-3 mb-2 mt-auto">
            <%= image_tag "grammar_game_experience_bar", height: "25px", width: "25px", class: "grammar-game-experience-bar-img ms-2" %>
            <p class="student-challenges-card-experience text-white"><%= submission.present? ? (submission.score || 0) + (submission.games.map(&:score).compact.sum) : 0 %></p>
          </div>
        </div>
      <% end %>
    </div>
    <div class="d-flex flex-column student-challenges-ranking-container">
      <div class="student-challenges-ranking-card-title d-flex justify-content-center align-items-center">
        <p>Leaderboard</p>
      </div>
      <div class="m-3 student-challenges-ranking-card-container">
        <% @students_ranking.each do |student| %>
          <div class="student-challenges-ranking-card d-flex p-2 justify-content-start align-items-center my-2">
            <%= cl_image_tag student.photo.key, height: 40, width: 40, class: "student-challenge-raking-card-photo " %>
            <div class="student-challenges-ranking-pentagon mx-2">
              <p class="student-challenges-ranking-level">22</p>
            </div>
            <p class="student-challenges-ranking-card-name"><%= student.first_name %></p>
            <%= image_tag "grammar_game_experience_bar", height: "25px", width: "25px", class: "grammar-game-experience-bar-img ms-2" %>
            <p class="student-challenges-ranking-experience-number"><%= (student.submissions.map{|submission| submission.score}.sum) + (student.submissions.flat_map(&:games).select{|game| game.score.present?}.map{|game| game.score}.sum) %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
